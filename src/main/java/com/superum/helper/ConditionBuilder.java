package com.superum.helper;

import org.jooq.Condition;
import org.jooq.Record;
import org.jooq.TableField;

import java.util.function.Function;
import java.util.function.Predicate;

/**
 * <pre>
 * Builds a jooq Condition only from certain set fields of a given object
 *
 * Please refer to implementations of API v2 DAO/Queries interfaces for examples
 * </pre>
 * @param <Entity> a class that holds the values to check the fields with
 * @param <TableRecord> jooq Record type for the table that will be checked
 */
public class ConditionBuilder<Entity, TableRecord extends Record> {

    /**
     * <pre>
     * Checks if some field is set, and if it is, adds the check for its value to the Condition
     * </pre>
     * @param hasField a predicate which checks if a field is set, probably a method reference, i.e. Entity::hasId
     * @param tableField a field of the table that should be checked for a value (if this value is present)
     * @param getter a function which retrieves the field's value, probably a method reference, i.e. Entity::getId
     * @param <T> the type of the table field and the object returned by getter
     *
     * @return this builder
     *
     * @throws IllegalArgumentException if any arguments are null
     */
    public <T> ConditionBuilder<Entity, TableRecord> fieldCheck(Predicate<Entity> hasField, TableField<TableRecord, T> tableField,  Function<Entity, T> getter) {
        if (hasField == null)
            throw new IllegalArgumentException("Predicate to check if field is set cannot be null");

        if (tableField == null)
            throw new IllegalArgumentException("Table field cannot be null");

        if (getter == null)
            throw new IllegalArgumentException("Value getter cannot be null");

        if (hasField.test(entity))
            condition = condition.and(tableField.eq(getter.apply(entity)));
        return this;
    }

    /**
     * @return the Condition generated by this builder
     */
    public Condition finalCondition() {
        return condition;
    }

    // CONSTRUCTORS

    public ConditionBuilder(Entity entity, TableField<TableRecord, Integer> partitionField, int partitionId) {
        if (entity == null)
            throw new IllegalArgumentException("Entity cannot be null");

        if (partitionField == null)
            throw new IllegalArgumentException("Partition id field cannot be null");

        this.entity = entity;
        this.condition = partitionField.eq(partitionId);
    }

    // PRIVATE

    private final Entity entity;
    private Condition condition;

}
